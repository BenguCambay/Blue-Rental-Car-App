---
- name: Install Kubernetes K3s and Kompose on Ubuntu
  hosts: _prod_server
  become: yes
  remote_user: ubuntu
  tasks:
    - name: Update APT package index
      apt:
        update_cache: yes

    - name: Install required dependencies
      apt:
        name: curl
        state: present

    - name: Download and install K3s
      shell: |
        curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Ensure K3s service is running
      systemd:
        name: k3s
        enabled: yes
        state: started

    - name: Download and install Kompose
      shell: |
        curl -L https://github.com/kubernetes/kompose/releases/download/v1.26.1/kompose-linux-amd64 -o /usr/local/bin/kompose
        chmod +x /usr/local/bin/kompose
      args:
        creates: /usr/local/bin/kompose

    - name: Verify Kompose installation
      command: kompose version
      register: kompose_version_output
      changed_when: false

    - name: Print Kompose version
      debug:
        var: kompose_version_output.stdout

    - name: Display K3s node status
      command: kubectl get nodes
      register: k3s_nodes_status
      changed_when: false

    - name: Print K3s node status
      debug:
        var: k3s_nodes_status.stdout
